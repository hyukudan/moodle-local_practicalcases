/**
 * Bulk actions module for practical cases.
 *
 * @module     local_casospracticos/bulk_actions
 * @copyright  2026 Sergio C.
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
/**
 * Bulk actions module for practical cases.
 *
 * @module     local_casospracticos/bulk_actions
 * @copyright  2026 Sergio C.
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_casospracticos/bulk_actions",["jquery","core/ajax","core/notification","core/str","core/modal_factory","core/modal_events"],function(e,t,o,s,c,i){var n=function(){this.selectedIds=[],this.strings={},this.init()};return n.prototype.init=function(){var e=this;s.get_strings([{key:"confirmdeleteselected",component:"local_casospracticos"},{key:"confirmpublishselected",component:"local_casospracticos"},{key:"confirmarchiveselected",component:"local_casospracticos"},{key:"delete"},{key:"cancel"},{key:"publish",component:"local_casospracticos"},{key:"archive",component:"local_casospracticos"},{key:"move",component:"local_casospracticos"},{key:"nocasesselected",component:"local_casospracticos"},{key:"casesdeleted",component:"local_casospracticos"},{key:"casespublished",component:"local_casospracticos"},{key:"casesarchived",component:"local_casospracticos"},{key:"casesmoved",component:"local_casospracticos"},{key:"selecttargetcategory",component:"local_casospracticos"}]).then(function(t){e.strings={confirmDelete:t[0],confirmPublish:t[1],confirmArchive:t[2],delete:t[3],cancel:t[4],publish:t[5],archive:t[6],move:t[7],noCasesSelected:t[8],casesDeleted:t[9],casesPublished:t[10],casesArchived:t[11],casesMoved:t[12],selectTargetCategory:t[13]},e.bindEvents(),e.updateBulkActionsVisibility()}).catch(o.exception)},n.prototype.bindEvents=function(){var t=this;e(document).on("change",".case-select-checkbox",function(){t.updateSelection()}),e(document).on("change","#select-all-cases",function(){var o=e(this).is(":checked");e(".case-select-checkbox").prop("checked",o),t.updateSelection()}),e(document).on("click","[data-bulk-action]",function(o){o.preventDefault();var s=e(this).data("bulk-action");t.executeBulkAction(s)})},n.prototype.updateSelection=function(){this.selectedIds=[];var t=this;e(".case-select-checkbox:checked").each(function(){t.selectedIds.push(parseInt(e(this).val(),10))}),this.updateBulkActionsVisibility(),this.updateSelectedCount()},n.prototype.updateBulkActionsVisibility=function(){this.selectedIds.length>0?e(".bulk-actions-container").removeClass("d-none"):e(".bulk-actions-container").addClass("d-none")},n.prototype.updateSelectedCount=function(){e(".selected-count").text(this.selectedIds.length)},n.prototype.showLoading=function(){e("[data-bulk-action]").prop("disabled",!0),e(".bulk-actions-container").addClass("loading")},n.prototype.hideLoading=function(){e("[data-bulk-action]").prop("disabled",!1),e(".bulk-actions-container").removeClass("loading")},n.prototype.executeBulkAction=function(e){if(0!==this.selectedIds.length)switch(e){case"delete":this.confirmDelete();break;case"publish":this.confirmPublish();break;case"archive":this.confirmArchive();break;case"move":this.showMoveDialog();break;case"export-pdf":this.exportPDF();break;case"export-csv":this.exportCSV();break;default:console.warn("Unknown bulk action:",e)}else o.addNotification({message:this.strings.noCasesSelected,type:"warning"})},n.prototype.confirmDelete=function(){var e=this;c.create({type:c.types.SAVE_CANCEL,title:this.strings.delete,body:this.strings.confirmDelete.replace("{$a}",this.selectedIds.length)}).then(function(t){return t.setSaveButtonText(e.strings.delete),t.getRoot().on(i.save,function(){e.doDelete()}),t.show(),t}).catch(o.exception)},n.prototype.doDelete=function(){var e=this;this.showLoading(),t.call([{methodname:"local_casospracticos_bulk_delete",args:{caseids:this.selectedIds}}])[0].done(function(t){e.hideLoading(),t.success?(o.addNotification({message:e.strings.casesDeleted.replace("{$a}",t.deleted.length),type:"success"}),window.location.reload()):(o.addNotification({message:t.deleted.length+" deleted, "+t.failed.length+" failed",type:"warning"}),window.location.reload())}).fail(function(t){e.hideLoading(),o.exception(t)})},n.prototype.confirmPublish=function(){var e=this;c.create({type:c.types.SAVE_CANCEL,title:this.strings.publish,body:this.strings.confirmPublish.replace("{$a}",this.selectedIds.length)}).then(function(t){return t.setSaveButtonText(e.strings.publish),t.getRoot().on(i.save,function(){e.doPublish()}),t.show(),t}).catch(o.exception)},n.prototype.doPublish=function(){var e=this;this.showLoading(),t.call([{methodname:"local_casospracticos_bulk_publish",args:{caseids:this.selectedIds}}])[0].done(function(t){e.hideLoading();var s=e.strings.casesPublished.replace("{$a}",t.published.length);t.failed.length>0&&(s+=" ("+t.failed.length+" failed)"),o.addNotification({message:s,type:t.success?"success":"warning"}),window.location.reload()}).fail(function(t){e.hideLoading(),o.exception(t)})},n.prototype.confirmArchive=function(){var e=this;c.create({type:c.types.SAVE_CANCEL,title:this.strings.archive,body:this.strings.confirmArchive.replace("{$a}",this.selectedIds.length)}).then(function(t){return t.setSaveButtonText(e.strings.archive),t.getRoot().on(i.save,function(){e.doArchive()}),t.show(),t}).catch(o.exception)},n.prototype.doArchive=function(){var e=this;this.showLoading(),t.call([{methodname:"local_casospracticos_bulk_archive",args:{caseids:this.selectedIds}}])[0].done(function(t){e.hideLoading(),t.success&&(o.addNotification({message:e.strings.casesArchived.replace("{$a}",t.archived.length),type:"success"}),window.location.reload())}).fail(function(t){e.hideLoading(),o.exception(t)})},n.prototype.escapeHtml=function(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML},n.prototype.showMoveDialog=function(){var e=this;t.call([{methodname:"local_casospracticos_get_categories",args:{}}])[0].done(function(t){var s=t.map(function(t){for(var o="",s=0;s<t.depth;s++)o+="&nbsp;&nbsp;";return'<option value="'+parseInt(t.id,10)+'">'+o+e.escapeHtml(t.name)+"</option>"}).join(""),n='<div class="form-group"><label for="target-category">'+e.strings.selectTargetCategory+':</label><select class="form-control" id="target-category">'+s+"</select></div>";c.create({type:c.types.SAVE_CANCEL,title:e.strings.move,body:n}).then(function(t){return t.setSaveButtonText(e.strings.move),t.getRoot().on(i.save,function(){var o=t.getRoot().find("#target-category").val();e.doMove(parseInt(o,10))}),t.show(),t}).catch(o.exception)}).fail(o.exception)},n.prototype.doMove=function(e){var s=this;this.showLoading(),t.call([{methodname:"local_casospracticos_bulk_move",args:{caseids:this.selectedIds,categoryid:e}}])[0].done(function(e){s.hideLoading(),e.success&&(o.addNotification({message:s.strings.casesMoved.replace("{$a}",e.moved.length),type:"success"}),window.location.reload())}).fail(function(e){s.hideLoading(),o.exception(e)})},n.prototype.exportPDF=function(){var e=this.selectedIds.filter(function(e){return Number.isInteger(e)&&e>0});if(0!==e.length){var t=M.cfg.wwwroot+"/local/casospracticos/export.php?format=pdf&ids="+e.join(",")+"&sesskey="+M.cfg.sesskey;window.location.href=t}},n.prototype.exportCSV=function(){var e=this.selectedIds.filter(function(e){return Number.isInteger(e)&&e>0});if(0!==e.length){var t=M.cfg.wwwroot+"/local/casospracticos/export.php?format=csv&ids="+e.join(",")+"&sesskey="+M.cfg.sesskey;window.location.href=t}},{init:function(){return new n}}});
