define(["local_casospracticos/repository","core/notification","core/str"],function(e,t,n){var i=null,a=null,o=null,s=null,r=null,c=function(){(r=document.createElement("div")).id="autosave-status",r.className="autosave-status",r.style.cssText="position: fixed; bottom: 20px; right: 20px; padding: 8px 16px; border-radius: 4px; font-size: 12px; z-index: 9999; transition: opacity 0.3s; opacity: 0;",document.body.appendChild(r)},u=function(e,t){if(r){var n="#6c757d";"saved"===t?n="#28a745":"error"===t?n="#dc3545":"saving"===t&&(n="#007bff"),r.style.backgroundColor=n,r.style.color="#fff",r.textContent=e,r.style.opacity="1","saving"!==t&&setTimeout(function(){r.style.opacity="0"},3e3)}},f=function(){i&&clearInterval(i),i=setInterval(function(){l()},3e4)},d=function(){var e=document.querySelector(o);if(!e)return{};var t={},n=new FormData(e);for(var i of n.entries()){var a=i[0],s=i[1];if("sesskey"!==a){var r=a.match(/^q(\d+)(\[\])?$/);if(r){var c=r[1];"[]"===r[2]?(t[c]||(t[c]=[]),t[c].push(s)):t[c]=s}var u=a.match(/^q(\d+)_(\d+)$/);if(u){var f=u[1],d=u[2];t[f]||(t[f]={}),t[f][d]=s}}}return t},v=function(e){return null===s||JSON.stringify(e)!==JSON.stringify(s)},l=function(){var t=d();v(t)&&0!==Object.keys(t).length&&(n.get_string("saving","admin").then(function(e){u(e+"...","saving")}).catch(function(){u("Saving...","saving")}),e.savePracticeResponses(a,t).then(function(e){e.success?(s=t,n.get_string("changessaved","moodle").then(function(e){u(e,"saved")}).catch(function(){u("Saved","saved")})):u("Auto-save failed","error")}).catch(function(){u("Auto-save error","error")}))},p=function(){var e=d();if(v(e)&&0!==Object.keys(e).length&&navigator.sendBeacon){var t=M.cfg.wwwroot+"/lib/ajax/service.php?sesskey="+M.cfg.sesskey,n=JSON.stringify([{index:0,methodname:"local_casospracticos_save_practice_responses",args:{attemptid:a,responses:JSON.stringify(e)}}]);navigator.sendBeacon(t,n)}},g=function(e,t){var n;return function(){var i=this,a=arguments;clearTimeout(n),n=setTimeout(function(){e.apply(i,a)},t)}};return{init:function(e){a=e.attemptId,o=e.formSelector||"form",c(),f();var t=document.querySelector(o);t&&t.addEventListener("change",g(function(){l()},2e3)),window.addEventListener("beforeunload",function(){p()}),document.addEventListener("visibilitychange",function(){"hidden"===document.visibilityState&&l()})},saveResponses:l,stopAutoSave:function(){i&&(clearInterval(i),i=null)}}});