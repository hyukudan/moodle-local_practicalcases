/**
 * Question editor module for practical cases.
 *
 * @module     local_casospracticos/question_editor
 * @copyright  2026 Sergio C.
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
/**
 * Question editor module for practical cases.
 *
 * @module     local_casospracticos/question_editor
 * @copyright  2026 Sergio C.
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_casospracticos/question_editor",["jquery","core/ajax","core/notification","core/templates","core/modal_factory","core/modal_events"],function(e,t,a,n,o,s){var r=function(e){this.caseId=e,this.modal=null,this.answerCount=0};return r.prototype.open=function(e){var t=this,s={caseid:this.caseId,uniqid:"qe_"+Date.now(),qtypes:[{value:"multichoice",label:"Opción múltiple",selected:!0},{value:"truefalse",label:"Verdadero/Falso",selected:!1},{value:"shortanswer",label:"Respuesta corta",selected:!1}]};return(e?this.loadQuestion(e).then(function(e){return s.question=e,s.qtypes.forEach(function(t){t.selected=t.value===e.qtype}),s}):Promise.resolve(s)).then(function(e){return n.render("local_casospracticos/question_form",e)}).then(function(t){return o.create({type:o.types.DEFAULT,title:e?"Editar pregunta":"Nueva pregunta",body:t,large:!0})}).then(function(e){return t.modal=e,t.bindModalEvents(),e.show(),e}).catch(a.exception)},r.prototype.loadQuestion=function(e){return t.call([{methodname:"local_casospracticos_get_questions",args:{caseid:this.caseId}}])[0].then(function(t){for(var a=0;a<t.length;a++)if(t[a].id===e)return t[a];throw new Error("Question not found")})},r.prototype.bindModalEvents=function(){var t=this,a=this.modal.getRoot();a.on("submit","form",function(a){a.preventDefault(),t.saveQuestion(e(this))}),a.on("click",'[data-action="cancel"]',function(){t.modal.hide()}),a.on("click",'[id^="add-answer-"]',function(){t.addAnswerRow()}),a.on("click",".remove-answer",function(){e(this).closest(".answer-row").remove()}),a.on("change",'[id^="qtype-"]',function(){t.handleQtypeChange(e(this).val())})},r.prototype.addAnswerRow=function(){var e=this.modal.getRoot().find('[id^="answers-container-"]');n.render("local_casospracticos/answer_row",{}).then(function(t){e.append(t)}).catch(a.exception)},r.prototype.handleQtypeChange=function(e){var t=this.modal.getRoot().find(".answers-section");"truefalse"===e?(t.find(".answers-container").html('<div class="answer-row card mb-2"><div class="card-body py-2"><div class="row g-2"><div class="col-md-8"><input type="text" class="form-control form-control-sm" name="answer_text[]" value="Verdadero" readonly></div><div class="col-md-4"><select class="form-select form-select-sm" name="answer_fraction[]"><option value="1.0">Correcta</option><option value="0.0" selected>Incorrecta</option></select></div></div></div></div><div class="answer-row card mb-2"><div class="card-body py-2"><div class="row g-2"><div class="col-md-8"><input type="text" class="form-control form-control-sm" name="answer_text[]" value="Falso" readonly></div><div class="col-md-4"><select class="form-select form-select-sm" name="answer_fraction[]"><option value="1.0">Correcta</option><option value="0.0" selected>Incorrecta</option></select></div></div></div></div>'),t.find('[id^="add-answer-"]').hide()):t.find('[id^="add-answer-"]').show()},r.prototype.saveQuestion=function(e){var n=this,o=this.collectFormData(e);if(this.validateForm(o)){var s=o.id?"local_casospracticos_update_question":"local_casospracticos_create_question",r=o.id?{id:o.id,questiontext:o.questiontext,defaultmark:o.defaultmark}:{caseid:o.caseid,questiontext:o.questiontext,qtype:o.qtype,defaultmark:o.defaultmark,answers:o.answers};t.call([{methodname:s,args:r}])[0].done(function(e){e.success&&(n.modal.hide(),window.location.reload())}).fail(a.exception)}},r.prototype.collectFormData=function(t){var a={caseid:parseInt(t.find('[name="caseid"]').val(),10),id:parseInt(t.find('[name="id"]').val(),10)||null,qtype:t.find('[name="qtype"]').val(),questiontext:t.find('[name="questiontext"]').val(),defaultmark:parseFloat(t.find('[name="defaultmark"]').val())||1,shuffleanswers:parseInt(t.find('[name="shuffleanswers"]').val(),10),generalfeedback:t.find('[name="generalfeedback"]').val(),answers:[]};return t.find(".answer-row").each(function(){var t=e(this).find('[name="answer_text[]"]').val();t&&t.trim()&&a.answers.push({answer:t.trim(),fraction:parseFloat(e(this).find('[name="answer_fraction[]"]').val())||0,feedback:e(this).find('[name="answer_feedback[]"]').val()||""})}),a},r.prototype.validateForm=function(e){return e.questiontext&&e.questiontext.trim()?e.answers.length<2&&"shortanswer"!==e.qtype?(a.addNotification({message:"Se necesitan al menos 2 respuestas",type:"error"}),!1):!(!e.answers.some(function(e){return e.fraction>0})&&"shortanswer"!==e.qtype)||(a.addNotification({message:"Se necesita al menos una respuesta correcta",type:"error"}),!1):(a.addNotification({message:"El texto de la pregunta es obligatorio",type:"error"}),!1)},{create:function(e){return new r(e)},newQuestion:function(e){new r(e).open(null)},editQuestion:function(e,t){new r(e).open(t)}}});
